---
title: "Lab 3 - Exploratory Data Analysis"
link-citations: true
toc: false
format:
  html:
    embed-resources: true
---

```{r}
#install.packages(c("data.table","leaflet"))
library(leaflet)
library(tidyverse)
```

# Learning Goals

-   Read in and get familiar with the meteorology dataset\
-   Step through the EDA "checklist" presented in the class slides
-   Practice making exploratory graphs

As you do this, think about what questions you would like to ask regarding this data. What would you ask a collaborator who was more familiar with it?

# Lab Description

We will work with the meteorological data presented in lecture. Recall the dataset consists of weather station readings in the continental US.

**The objective of the lab is to find the weather station with the highest elevation and look at patterns in the time series of its wind speed and temperature.**

# Steps

### 1. Read in the data

The data for this lab is available at <https://github.com/dmcable/BIOSTAT620W26/tree/main/data/met>. There's some additional information about the dataset, but the main file you'll need to download is `met_all.gz`.

Once you've downloaded the file, you can read it into R with:

```{r}
met <- read.csv("C:/Users/chuntseh/Downloads/met_all.gz")
```

### 2. Check the dimensions, headers, footers
```{r}
dim(met)
head(met)
tail(met)
```


-   How many columns, rows are there?
30 columns and 2377343 rows

### 3. Take a look at all the variables (hint: use the str function).
```{r}
str(met)
```

### 4. Take a closer look at the key variables (year, day, hour, temp, elev, wind.sp). Hint: use table and/or summary).
```{r}
summary(met)
```

It looks like the elevation variable has observations with 9999.0, which is probably an indicator for missing. We should take a deeper look at the data dictionary to confirm. The wind speed variable is OK but there are a lot of missing data.

After checking the data we should make the appropriate modifications. Replace elevations with 9999 as `NA`.

-   At what elevation is the highest weather station?
```{r}
# Replace the 9999 missing value indicator with NA
met[met$elev == 9999, "elev"] <- NA
summary(met$elev)

# Find the maximum elevation value
max_elev <- max(met$elev, na.rm = TRUE)
max_elev

```
Ans: 4113

We also have the issue of the minimum temperature being -40C, so we should remove those observations. Also, remove the NA temperature points.

After removing the -40C points, what is the new lowest temperature? We again notice that there is a -17.2C temperature reading that seems suspicious.
Ans: the new lowest temperature is -17.2c
```{r}
# Remove observations where temperature is -40
met <- met[met$temp != -40, ]

# Remove NA temperature points
met <- met[!is.na(met$temp), ]

# Check the new minimum temperature
min_temp <- min(met$temp)
min_temp

```


### 5. Check the data against an external data source.

Validate that the total range of elevations in the data make sense. Also, we should check the suspicious -17.2C temperature value (where is it located?).

Google is your friend here.

Fix any problems that arise in your checks.
```{r}
# Check range
elev_range <- range(met$elev, na.rm = TRUE)
elev_range

# Identify the location of the -17.2C
suspicious_stations <- unique(met[met$temp == -17.2, c("USAFID", "lat", "lon", "elev")])
print(suspicious_stations)

# Validate from Google
#A latitude of 38.7 and a longitude of -121.0 => Northern California,near Sacramento.A reading of -17.2°C during August is physically impossible.

# Remove the suspicious -17.2C (0°F) values
met2 <- met[met$temp != -17.2, ]

```
Ans: total range is -13 to 4113

### 6. Calculate summary statistics

Remember to keep the initial question in mind. We want to pick out the weather station with maximum elevation and examine its windspeed and temperature.

Some ideas: select the weather station with maximum elevation; within this station, look at the correlation between temperature and wind speed; look at the correlation between each of temperature and wind speed with each of hour and day.
```{r}
# Identify the highest station
max_elev_val <- max(met$elev, na.rm = TRUE)
highest_station <- met[met$elev == max_elev_val & !is.na(met$elev), ]

# Get the unique ID for this station
station_id <- unique(highest_station$USAFID)
cat("Analyzing Station ID:", station_id, "at elevation:", max_elev_val, "meters\n")

# Correlation: Temperature vs. Wind Speed
cor_temp_wind <- cor(highest_station$temp, highest_station$wind.sp, use = "complete.obs")

# Correlation: Time-based patterns
# Temperature vs. Hour and Day
cor_temp_hour <- cor(highest_station$temp, highest_station$hour, use = "complete.obs")
cor_temp_day  <- cor(highest_station$temp, highest_station$day, use = "complete.obs")

# Wind Speed vs. Hour and Day
cor_wind_hour <- cor(highest_station$wind.sp, highest_station$hour, use = "complete.obs")
cor_wind_day  <- cor(highest_station$wind.sp, highest_station$day, use = "complete.obs")

# Display results
cat("Correlation (Temp vs Wind Speed):", cor_temp_wind, "\n")
cat("Correlation (Temp vs Hour):", cor_temp_hour, "\n")
cat("Correlation (Wind vs Hour):", cor_wind_hour, "\n")
```


### 7. Exploratory graphs

We should look at the distributions of all of the key variables to make sure there are no remaining issues with the data. Hint: using the hist function, make histograms of the elev, temp, and wind.sp variables.
```{r}
# Set up the plotting window for 3 graphs in one row
par(mfrow = c(1, 3))

# Histogram for Elevation
hist(met$elev, 
     main = "Distribution of Elevation", 
     xlab = "Elevation (m)", 
     col = "lightblue", 
     breaks = 50)

# Histogram for Temperature
hist(met$temp, 
     main = "Distribution of Temperature", 
     xlab = "Temperature (C)", 
     col = "tomato", 
     breaks = 50)

# Histogram for Wind Speed
hist(met$wind.sp, 
     main = "Distribution of Wind Speed", 
     xlab = "Wind Speed (m/s)", 
     col = "lightgreen", 
     breaks = 50)

# Reset plotting window to default
par(mfrow = c(1, 1))
```


Note: one thing we should consider for later analyses (not today) is to log transform wind speed and elevation as they are very skewed.

Look at where the weather station with highest elevation is located.

```{r}
# Identify the highest station coordinates
max_elev_df <- met[met$elev == max(met$elev, na.rm = TRUE) & !is.na(met$elev), ]

high_station_loc <- unique(max_elev_df[, c("lat", "lon")])

leaflet(high_station_loc) %>%
  addProviderTiles('OpenStreetMap') %>% 
  addCircles(lat=~lat, lng=~lon, opacity=1, fillOpacity=1, radius=100, color="red")
```

Look at the time series of temperature and wind speed at this location. For this we will need to create a date-time variable for the x-axis.

```{r message=FALSE, eval=FALSE}
library(lubridate)
max_elev_df$date <- with(max_elev_df, ymd_h(paste(year, month, day, hour, sep= ' ')))
max_elev_df <- max_elev_df[order(max_elev_df$date), ]

# Plot Temperature Time Series
plot(max_elev_df$date, max_elev_df$temp, 
     type = "l", 
     col = "red", 
     main = "Temperature at Highest Elevation",
     xlab = "Date", ylab = "Temp (C)")

# Plot Wind Speed Time Series
plot(max_elev_df$date, max_elev_df$wind.sp, 
     type = "l", 
     col = "blue", 
     main = "Wind Speed at Highest Elevation",
     xlab = "Date", ylab = "Wind Speed (m/s)")
```

Given the date-time variable, plot the time series of temperature and also wind speed.

-   Summarize any trends that you see in these time series plots.
Ans: Temperatures peak in the late afternoon and drop sharply overnight.Wind: Spiky distribution with no smooth daily rhythm.

### 8. Ask questions

By now, you might have some specific questions about how the data was gathered and what some of the different variables and values mean. Alternatively, maybe you have an idea for how some of the variable should be related and you want to explore that relationship. In a real-world analysis, these questions could potentially be answered by a collaborator, who may have been part of the team that collected the data. What questions do you have about the data?

Question:
The data contains a GEOPHYSICAL-REPORT-TYPE code (e.g., METAR, SY-MT, AUTO). Do the trends at the highest station change if we filter for only "AUTO" (automatic) vs. manual "AERO" reports?

If you haven't already, now would be a good time to look at the accompanying [data dictionary](https://github.com/dmcable/BIOSTAT620W26/tree/main/data/met/met-datadictionary.pdf) for this dataset and see if it can answer any of your questions. If you have questions about the nature of the dataset and how it was gathered, this might be able to help.

For questions about variables in the dataset or relationships between them, try making some more exploratory plots. Do you see the patterns you would expect? There are many different types of summaries and visualization strategies that we have not discussed, but which could provide interesting perspectives on the data.
```{r}
# Randomly sample 500 rows
met_sample <- met[sample(nrow(met), 500), ]

plot(met_sample$temp, met_sample$dew.point, 
     pch = 19, cex = 0.5, col = rgb(0,0,1,0.1),
     main = "Temp vs. Dew Point (Sampled 50k points)",
     xlab = "Air Temperature (C)", ylab = "Dew Point (C)")
abline(0, 1, col = "red", lwd = 2)
```
Ans: My assumed pattern is that Air Temperature should always be greater than or equal to the Dew Point.

Some other useful plotting functions include: 

- `pairs` for making all pairwise scatter plots in a dataset with 2 dimensions. 
- `heatmap` and/or `corrplot` (from the `corrplot` package) for visualizing matrices in general or correlation matrices in particular. 
- `image` a low-level matrix visualization function 
- `barplot`, especially with `table`, for visualizing frequencies of categorical variables.

### 9. Submission (due Tuesday, Feb 03 at 8:30am)

Submit through the course [Github issues page](https://github.com/dmcable/BIOSTAT620W26/issues/1).
